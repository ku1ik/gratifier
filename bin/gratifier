#!/bin/bash

size=32

mkdir -p $HOME/.gratifier/avatars/$size
mkdir -p $HOME/.gratifier/nicknames

function notify {
  if [ $(which notify-send 2>/dev/null) ]; then
    notify-send -i "$3" "$1" "$2"
  elif [ $(which growlnotify 2>/dev/null) ]; then
    app_name=$(basename $0)
    growlnotify -n "$app_name" --image "$3" -m "$2" "$1"
  elif [ $(which kdialog 2>/dev/null) ]; then
    kdialog --icon $3 --title "$1" --passivepopup "$2"
  else
    echo "No notification utility found. Please install libnotify-bin, kdialog or growlnotify."
    exit 1
  fi
}

function calc_md5_sum {
  if [ $(which md5sum 2>/dev/null) ]; then
    echo -n "$1" | md5sum | cut -f1 -d' '
  elif [ $(which md5 2>/dev/null) ]; then
    echo -n "$1" | md5
  fi
}

if [[ -n "$GRAVATAR_EMAIL" ]]; then
  email=$GRAVATAR_EMAIL
elif [[ -n "$NICKNAME" ]]; then
  nickname_path="$HOME/.gratifier/nicknames/$NICKNAME"

  if [[ -f "$nickname_path" ]]; then
    email=$(cat "$nickname_path" 2>/dev/null)
  else
    touch "$nickname_path"
  fi
fi

if [[ -n "$email" ]]; then
  email_hash=$(calc_md5_sum $email)
  avatar_path="$HOME/.gratifier/avatars/$size/$email_hash"

  if [[ ! -f $avatar_path ]]; then
    curl -s "http://www.gravatar.com/avatar/$email_hash?s=$size&d=/default" -o $avatar_path

    if [[ ! -f $avatar_path ]]; then
      avatar_path="/some/default/icon.png"
    fi
  fi

  notify "$1" "$2" $avatar_path
else
  notify "$1" "$2"
fi
